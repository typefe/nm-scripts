#!/bin/bash

# Get the network interface and state from Network Dispatcher
INTERFACE="$1"
STATE="$2"

# --- GLOBAL CONFIGURATION ---
EXEC_USER="typefe"
USER_HOME="/home/$EXEC_USER"

ZAPRET_CONFIG_FILE="/opt/zapret/config"
LOG_FILE="/var/log/ibbwifi-autologin.log"

# --- VIRTUAL ENVIRONMENT CONFIGURATION ---
# Dynamically build paths using the global user variable
VENV_PYTHON="$USER_HOME/Desktop/Cloud/w/PROGRAMMING/PYTHON/Exercise/captive_auto_login/venv/bin/python"
SCRIPT_PATH="$USER_HOME/Desktop/Cloud/w/PROGRAMMING/PYTHON/Exercise/captive_auto_login/script.py"

# Options
CHECK_TARGET_IP="8.8.8.8" 
CHECK_TARGET_PORT="443"

ZAPRET_IBBWIFI_OPT='NFQWS_OPT="--filter-tcp=443 --dpi-desync=fakedsplit --dpi-desync-ttl=1 --dpi-desync-autottl=-2 --dpi-desync-split-pos=1 <HOSTLIST> --new --filter-tcp=80 --dpi-desync=fakedsplit --dpi-desync-ttl=1 --dpi-desync-autottl=-2 --dpi-desync-split-pos=method+2 <HOSTLIST>"'
ZAPRET_DEFAULT_OPT='NFQWS_OPT="--filter-tcp=443 --dpi-desync=multidisorder --dpi-desync-split-pos=sniext+1 --dpi-desync-split-seqovl=sniext <HOSTLIST> --new --filter-udp=50000-65535 --dpi-desync=fake --dpi-desync-repeats=3 <HOSTLIST>"'

# 1. Only act if the primary wireless interface is coming up
if [[ "$INTERFACE" == "wlan0" && "$STATE" == "up" ]]; then
    
    # Wait a brief moment for the SSID to be associated
    sleep 2
    SSID=$(iwgetid -r)
    
    if [[ "$SSID" == "ibbWiFi" ]]; then
        echo "$(date): [ibbWiFi] Detected on wlan0." >> "$LOG_FILE"
        
        # --- OPTIMIZATION START ---
        # Check connectivity immediately using IP
        if ! nc -nzw5 $CHECK_TARGET_IP $CHECK_TARGET_PORT >/dev/null 2>&1; then
            echo "$(date): [ibbWiFi] Offline. Triggering captive login..." >> "$LOG_FILE"
            
            # Safely drop root privileges to the specified user just for this command
            su - "$EXEC_USER" -c "$VENV_PYTHON $SCRIPT_PATH" >> "$LOG_FILE" 2>&1
            
        else
            echo "$(date): [ibbWiFi] Already online." >> "$LOG_FILE"
        fi
        
        # Root resumes control here to restart system services
        sed -i "s|^NFQWS_OPT=.*|${ZAPRET_IBBWIFI_OPT}|" "$ZAPRET_CONFIG_FILE"
        systemctl restart zapret
        # --- OPTIMIZATION END ---

    else
        # 2. Handle all other networks
        echo "$(date): [$SSID] Detected. Applying default zapret config." >> "$LOG_FILE"
        sed -i "s|^NFQWS_OPT=.*|${ZAPRET_DEFAULT_OPT}|" "$ZAPRET_CONFIG_FILE"
        systemctl restart zapret
    fi
fi
